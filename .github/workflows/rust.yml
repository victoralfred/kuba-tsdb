# Comprehensive Rust CI/CD Pipeline for Kuba TSDB
# Handles linting, testing, coverage, security audits, and release management

name: Rust CI/CD

on:
  push:
    branches: ["main", "develop", "fet/**","feature/*", "fix/**", "release/**", "hotfix/**"," **/**","*"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["main", "*"]
  workflow_dispatch:
    inputs:
      run_benchmarks:
        description: "Run performance benchmarks"
        required: false
        default: false
        type: boolean
      skip_tests:
        description: "Skip test execution (lint only)"
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short
  # Use explicit paths for caching, necessary if runner environment varies
  CARGO_CACHE_DIR: ${{ github.workspace }}/.cargo/cache
  RUSTUP_CACHE_DIR: ${{ github.workspace }}/.rustup/cache

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Job 1: Code Quality Checks (Fast Feedback)
  # ============================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      # Corrected Caching: Using the explicit paths defined in env
      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_CACHE_DIR }}/bin/
            ${{ env.CARGO_CACHE_DIR }}/registry/index/
            ${{ env.CARGO_CACHE_DIR }}/registry/cache/
            ${{ env.CARGO_CACHE_DIR }}/git/db/
            target/
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lint-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy (warnings as errors)
        run: cargo clippy --all-targets --all-features -- -D warnings -D clippy::all

      - name: Check documentation
        run: cargo doc --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: "-D warnings"

  # ------------------------------------------------------------
  # Job 2: Security Audit
  # ------------------------------------------------------------
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      # Removed caching for cargo-audit binary (simplifying)
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit (vulnerabilities)
        run: cargo audit --deny warnings

      - name: Check for unmaintained dependencies
        run: cargo audit --deny unmaintained
        continue-on-error: true # Allow soft failures for unmaintained dependencies

  # ============================================================
  # Job 3: Build and Test Matrix
  # ============================================================
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.rust }}, ${{ matrix.profile }})
    needs: [lint]
    if: ${{ !inputs.skip_tests }}
    # Expanded matrix to include non-Linux OSes (as discussed, to monitor for failures)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, beta]
        profile: [debug, release]
        exclude:
          # Optimization: Skip beta + release to save CI time
          - rust: beta
            profile: release
          # Optimization: Skip less critical Windows/Mac runs
          - os: windows-latest
            rust: beta
          - os: macos-latest
            rust: beta

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust ${{ matrix.rust }} toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry and build
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_CACHE_DIR }}
            target/
          key: ${{ runner.os }}-${{ matrix.rust }}-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.rust }}-${{ matrix.profile }}-
            ${{ runner.os }}-${{ matrix.rust }}-

      - name: Build
        # **FIXED:** Explicitly setting the shell to 'bash' ensures the '\' line continuation works on all runners.
        shell: bash
        run: |
          cargo build \
            ${{ matrix.profile == 'release' && '--release' || '' }} \
            --all-targets \
            --locked

      # Add Conditional Check: Allow non-Ubuntu tests to fail without blocking the run
      - name: Run unit and integration tests
        # The '|| true' allows the step to finish successfully even if tests fail on non-primary OSes
        # Branch protection rules MUST be set to require only the Ubuntu runs.
        shell: bash # Setting shell to bash here too for consistency with the multi-line command
        run: |
          cargo test \
            ${{ matrix.profile == 'release' && '--release' || '' }} \
            --all-targets \
            --locked \
            -- --nocapture || [[ "${{ runner.os }}" == "Linux" ]] || true

      - name: Run doc tests
        run: cargo test --doc --locked

  # ============================================================
  # Job 4: Code Coverage
  # ============================================================
  coverage:
    name: Code Coverage
    # Depend on a single, known good run to save time, not the entire matrix
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate coverage report
        # We only need to build/test once here since cargo-llvm-cov handles it
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
          verbose: true
          # Use default GITHUB_TOKEN instead of a custom secret where possible
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }} 
          
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: lcov.info
          retention-days: 30

  # ============================================================
  # Job 5: Performance Benchmarks (Optional)
  # ============================================================
  benchmarks:
    name: Performance Benchmarks
    needs: [test]
    if: ${{ inputs.run_benchmarks || github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable


      - name: Run benchmarks
        run: cargo bench --no-fail-fast -- --output-format bencher | tee benchmark-results.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.txt
          retention-days: 90

  # ============================================================
  # Job 6: Build and Push Docker Image
  # ============================================================
  docker:
    name: Build Docker Image
    needs: [test, security]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Required for pushing to GHCR
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # Use GITHUB_TOKEN for publishing to GHCR
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ============================================================
  # Job 7: Create Release (on tags)
  # ============================================================
  release:
    name: Create Release
    needs: [test, security, docker]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating the release and uploading asset
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable


      - name: Build release binary
        run: cargo build --release --locked

      - name: Create tarball
        run: |
          BINARY_NAME=$(basename $(find target/release -maxdepth 1 -type f -executable ! -name 'build-*' | head -n 1))
          if [ -z "$BINARY_NAME" ]; then
            echo "Error: Could not find built release binary."
            exit 1
          fi
          mkdir -p release
          cp target/release/$BINARY_NAME release/
          cp README.md LICENSE* release/ 2>/dev/null || true
          tar -czvf Kuba-tsdb-${{ github.ref_name }}-linux-amd64.tar.gz -C release .

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since $PREV_TAG" > CHANGELOG.md
            git log --pretty=format:"- %s" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            echo "## Initial Release" > CHANGELOG.md
            git log --pretty=format:"- %s" >> CHANGELOG.md
          fi
        
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          files: |
            Kuba-tsdb-${{ github.ref_name }}-linux-amd64.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          # Use GITHUB_TOKEN for creating the release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------
  # Job 8: Dependency Review (PRs only)
  # ------------------------------------------------------------
  dependency-review:
    name: Dependency Review
    permissions:
      contents: read
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0